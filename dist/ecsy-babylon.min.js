!function(e,t){"use strict";function r(e){return e.world}class n extends t.System{constructor(){super(...arguments),this._scenes=new Map,this._assetManagers=new Map,this.onSceneSwitched=new e.Observable}get renderingCanvas(){return this._engine.getRenderingCanvas()}get activeSceneName(){return this._activeSceneName}init(){this._render=this._render.bind(this)}start(t,r,n,s){return this._engine=new e.Engine(t,r,n,s),this._engine.runRenderLoop(this._render),this}addScene(t,r){let n=new e.Scene(this._engine,r);this._scenes.set(t,n);let s=new e.AssetsManager(n);return s.useDefaultLoadingScreen=!1,this._assetManagers.set(t,s),1===this._engine.scenes.length&&(this._activeSceneName=t),this}removeScene(e){return e!==this.activeSceneName&&this.getScene(e).dispose(),this}switchScene(e){return this.getScene(e)&&(this._activeSceneName=e,this.onSceneSwitched.notifyObservers(this.getScene(e))),this}getScene(e){return e?this._scenes.get(e):this._scenes.get(this._activeSceneName)}getAssetManager(e){return e?this._assetManagers.get(e):this._assetManagers.get(this._activeSceneName)}_render(){r(this).execute(this._engine.getDeltaTime(),performance.now()),r(this).enabled&&this.getScene().render()}}function s(e,t,r){return e&&t&&r?{x:e,y:t,z:r}:{x:0,y:0,z:0}}class i{constructor(){this.position=s(),this.rotation=s(),this.scale=s(1,1,1)}}class o{constructor(){this.pointerLock=!1}}var a,c,d,h,u;!function(e){e.Box="Box",e.Plane="Plane",e.Sphere="Sphere",e.Ground="Ground"}(a||(a={}));class l{constructor(){this.type=a.Box,this.options={}}}!function(e){e.Point="Point",e.Directional="Directional",e.Spot="Spot",e.Hemispheric="Hemispheric"}(c||(c={}));class m{constructor(){this.type=c.Hemispheric,this.direction=s()}}function p(e){return r(e).getSystem(n)}function g(e,t){return p(e).getScene(t)}function f(e,t){return p(e).getAssetManager(t)}function y(e){return p(e).activeSceneName}function S(t){return e.Angle.FromDegrees(t).radians()}function b(t){return new e.Vector3(t.x,t.y,t.z)}function C(t){return new e.Vector3(S(t.x),S(t.y),S(t.z))}function x(t){return e.Color3.FromHexString(t)}function _(t){return e.Color4.FromHexString(t)}function v(e,t){e.object[t]=e[t]}function E(e,t){e.object[t]=b(e[t])}function w(e){let t=e.getComponents();for(let r in t){let n=t[r];n.object&&e.hasComponent(i)&&M(e.getMutableComponent(i),n)}}function M(e,t){let r=t.object;r.position&&(r.position=b(e.position)),r.rotation&&(r.rotation=C(e.rotation)),r.scaling&&(r.scaling=b(e.scale))}function q(e){e.object&&e.object.dispose()}function j(e,t,r){for(let n in t){let s=t[n];r.addTextureTask(n,s.url).onSuccess=t=>{let r=t.texture;for(let e in s)"url"!==e&&(r[e]=s[e]);let i=`${n}Texture`,o=e.object;o[i]&&q(o[i]),o[i]=r}}r.load(),r.reset()}class k{constructor(){var e;this.color=e?{diffuse:e}:{diffuse:"#ffffff"}}}!function(e){e.Point="Point",e.Box="Box",e.Sphere="Sphere",e.DirectedSphere="DirectedSphere",e.Hemisphere="Hemisphere",e.Cylinder="Cylinder",e.DirectedCylinder="DirectedCylinder",e.Cone="Cone"}(d||(d={}));class B{constructor(){this.type=d.Point,this.capacity=100,this.emitter=s(),this.direction1=s(),this.direction2=s(10,10,10),this.minEmitBox=s(),this.maxEmitBox=s()}}!function(e){e.Babylon="Babylon"}(h||(h={}));class N{constructor(){this.type=h.Babylon}}!function(e){e.Keyboard="Keyboard"}(u||(u={}));class P{constructor(){this.type=u.Keyboard}}class T extends t.System{execute(){this.queries.transforms.changed.forEach(e=>{w(e)})}}T.queries={transforms:{components:[i],listen:{changed:[i]}}};class D extends t.System{constructor(){super(...arguments),this._cameraOfScenes=new Map}init(){p(this).onSceneSwitched.add(e=>this._updateControl(e.uid))}execute(){this.queries.camera.added.forEach(t=>{let r=t.getComponent(o),n=g(this,r.sceneName);this._cameraOfScenes.set(n.uid,r),r.object=new e.FreeCamera("",e.Vector3.Zero(),n),w(t),this._updateControl(n.uid)}),this.queries.camera.removed.forEach(e=>{q(e.getComponent(o))})}_updateControl(e){let t=g(this,y(this));if(t.uid===e){let r=this._cameraOfScenes.get(e),n=p(this).renderingCanvas;r.object.attachControl(n,!0),r.pointerLock&&(t.onPointerDown=()=>{document.pointerLockElement||n.requestPointerLock()})}}}D.queries={camera:{components:[o],listen:{added:!0,removed:!0}}};class L extends t.System{execute(){this.queries.mesh.added.forEach(t=>{let r=t.getComponent(l);r.object=e.MeshBuilder[`Create${r.type}`].call(this,r.type,r.options,g(this,r.sceneName)),w(t)}),this.queries.mesh.changed.forEach(e=>{let t=e.getMutableComponent(l);for(let e in t)v(t,e)}),this.queries.mesh.removed.forEach(e=>{q(e.getComponent(l))})}}L.queries={mesh:{components:[l],listen:{added:!0,removed:!0,changed:[l]}}};class z extends t.System{execute(){this.queries.light.added.forEach(t=>{let r=t.getComponent(m),n=b(r.direction),s=g(this,r.sceneName);switch(r.type){case c.Point:r.object=new e.PointLight(r.type,e.Vector3.Zero(),s);break;case c.Directional:r.object=new e.DirectionalLight(r.type,n,s);break;case c.Spot:r.object=new e.SpotLight(r.type,e.Vector3.Zero(),n,S(r.angle),r.exponent,s);break;default:r.object=new e.HemisphericLight(c.Hemispheric,n,s)}this._updateLight(r),w(t)}),this.queries.light.changed.forEach(e=>{this._updateLight(e.getComponent(m))}),this.queries.light.removed.forEach(e=>{q(e.getComponent(m))})}_updateLight(e){for(let t in e)switch(t){case"direction":E(e,t);break;case"color":this._updateColor(e,e.color);break;default:v(e,t)}}_updateColor(e,t){for(let r in t)e.object[r]=x(t[r])}}z.queries={light:{components:[m],listen:{added:!0,removed:!0,changed:[m]}}};class A extends t.System{execute(){this.queries.meshMaterial.added.forEach(t=>{let r=t.getComponent(k);r.object=new e.StandardMaterial(r.color.diffuse,g(this,r.sceneName)),this._updateMaterial(r),t.getComponent(l).object.material=r.object}),this.queries.meshMaterial.changed.forEach(e=>{this._updateMaterial(e.getComponent(k))}),this.queries.meshMaterial.removed.forEach(e=>{q(e.getComponent(k)),e.getComponent(l).object.material=null})}_updateMaterial(e){for(let t in e)switch(t){case"color":this._updateColor(e,e.color);break;case"texture":j(e,e.texture,f(this,e.sceneName));break;default:v(e,t)}}_updateColor(e,t){for(let r in t)e.object[`${r}Color`]=x(t[r])}}A.queries={meshMaterial:{components:[l,k],listen:{added:!0,removed:!0,changed:[k]}}};class H extends t.System{execute(){this.queries.particle.added.forEach(t=>{let r=t.getComponent(B);r.object=new e.ParticleSystem(r.type,r.capacity,g(this,r.sceneName));let n=r.object;switch(r.type){case d.Point:n.createPointEmitter(b(r.direction1),b(r.direction2));break;case d.Box:n.createBoxEmitter(b(r.direction1),b(r.direction2),b(r.minEmitBox),b(r.maxEmitBox));break;case d.Sphere:n.createSphereEmitter(r.radius,r.radiusRange);break;case d.DirectedSphere:n.createDirectedSphereEmitter(r.radius,b(r.direction1),b(r.direction2));break;case d.Hemisphere:n.createHemisphericEmitter(r.radius,r.radiusRange);break;case d.Cylinder:n.createCylinderEmitter(r.radius,r.height,r.radiusRange,Math.random());break;case d.DirectedCylinder:n.createDirectedCylinderEmitter(r.radius,r.height,r.radiusRange,b(r.direction1),b(r.direction2));break;case d.Cone:n.createConeEmitter(r.radius,r.angle)}this._updateParticle(r),w(t),n.start()}),this.queries.particle.changed.forEach(e=>{this._updateParticle(e.getComponent(B))}),this.queries.particle.removed.forEach(e=>{let t=e.getComponent(B);t.object.stop(),q(t)})}_updateParticle(e){for(let t in e)switch(t){case"emitter":case"direction1":case"direction2":case"minEmitBox":case"maxEmitBox":E(e,t);break;case"texture":j(e,e.texture,f(this,e.sceneName));break;case"color":this._updateColor(e,e.color);break;default:v(e,t)}}_updateColor(e,t){for(let r in t)e.object[r]=_(t[r])}}H.queries={particle:{components:[B],listen:{added:!0,removed:!0,changed:[B]}}};class O extends t.System{execute(){this.queries.asset.added.forEach(e=>{let t=e.getComponent(N),r=f(this,t.sceneName);switch(t.type){default:{let n=t.url.lastIndexOf("/")+1;r.addMeshTask(h.Babylon,"",t.url.substring(0,n),t.url.substring(n,t.url.length)).onSuccess=r=>{t.object=r.loadedMeshes[0],w(e)};break}}r.load(),r.reset()}),this.queries.asset.removed.forEach(e=>{q(e.getComponent(N))})}}O.queries={asset:{components:[N],listen:{added:!0,removed:!0}}};class K extends t.System{execute(){this.queries.input.added.forEach(e=>{let t=e.getComponent(P);switch(t.type){case u.Keyboard:t.onKey&&g(this,t.sceneName).onKeyboardObservable.add(e=>t.onKey.call(t,e.event.key,1===e.type,2===e.type))}}),this.queries.input.removed.forEach(e=>{let t=e.getComponent(P);switch(t.type){case u.Keyboard:g(this,t.sceneName).onKeyboardObservable.clear()}})}}K.queries={input:{components:[P],listen:{added:!0,removed:!0}}};var R=Object.freeze({__proto__:null,GameSystem:n,TransformSystem:T,CameraSystem:D,MeshSystem:L,LightSystem:z,MaterialSystem:A,ParticleSystem:H,AssetSystem:O,InputSystem:K,Transform:i,Camera:o,get MeshTypes(){return a},Mesh:l,get LightTypes(){return c},Light:m,Material:k,get ParticleTypes(){return d},Particle:B,get AssetTypes(){return h},Asset:N,get InputTypes(){return u},Input:P,degreeToRadians:S,radiansToDegree:function(t){return e.Angle.FromRadians(t).degrees()},xyzToVector3:b,xyzToVector3Radians:C,vector3ToXyz:function(e){return{x:e.x,y:e.y,z:e.z}},vector3ToXyzDegree:function(e){return{x:e.x,y:e.y,z:e.z}},hexToColor3:x,hexToColor4:_,getScene:g,getActiveSceneName:y,getAssetManager:f});window.EB=R}(BABYLON,ECSY);
