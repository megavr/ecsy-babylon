!function(e,t){"use strict";class n{constructor(){this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0},this.scale={x:1,y:1,z:1},this.updateObjects=!0}}class i{constructor(){this.options={}}}var r,s,o,a,c,d,h,u,l,m,p,g;!function(e){e.Box="Box",e.Plane="Plane",e.Sphere="Sphere",e.Ground="Ground"}(r||(r={}));class f{constructor(){this.type=r.Box,this.options={}}}!function(e){e.Point="Point",e.Directional="Directional",e.Spot="Spot",e.Hemispheric="Hemispheric"}(s||(s={}));class y{constructor(){this.type=s.Hemispheric,this.direction={x:0,y:0,z:0}}}class b{constructor(){this.diffuse="#ffffff"}}!function(e){e.Point="Point",e.Box="Box",e.Sphere="Sphere",e.DirectedSphere="DirectedSphere",e.Hemisphere="Hemisphere",e.Cylinder="Cylinder",e.DirectedCylinder="DirectedCylinder",e.Cone="Cone"}(o||(o={}));class C{constructor(){this.type=o.Point,this.capacity=100,this.emitter={x:0,y:0,z:0},this.direction1={x:0,y:0,z:0},this.direction2={x:10,y:10,z:10},this.minEmitBox={x:0,y:0,z:0},this.maxEmitBox={x:0,y:0,z:0}}}!function(e){e.Babylon="Babylon"}(a||(a={}));class x{constructor(){this.type=a.Babylon}}!function(e){e.VrRight="VrRight",e.VrLeft="VrLeft"}(c||(c={}));class S{constructor(){this.type=c.VrRight}}function j(t){return e.Angle.FromDegrees(t).radians()}function _(e){return e.world}function E(e){e.object&&e.object.dispose()}function v(e){return _(e).getSystems().find(e=>void 0!==e.engine)}function M(e,t){return v(e).getScene(t)}function T(e){return v(e).currentCamera}function q(t){return new e.Vector3(t.x,t.y,t.z)}function B(t){return new e.Vector3(j(t.x),j(t.y),j(t.z))}function w(e){return{x:e.x,y:e.y,z:e.z}}function P(e){return{x:e.x,y:e.y,z:e.z}}function R(t){return e.Color3.FromHexString(t)}function O(t){return e.Color4.FromHexString(t)}function V(t,n,i){Object.keys(n).forEach(r=>{let s=n[r],o=new e.Texture(s.url,M(i,t.sceneName));Object.keys(s).filter(e=>"url"!==e).forEach(e=>o[e]=s[e]),t.object[`${r}Texture`]&&E(t.object[`${r}Texture`]),t.object[`${r}Texture`]=o})}function k(e){let t=e.getComponents(),n=[];return Object.keys(t).filter(e=>"object"in t[e]).forEach(e=>n.push(t[e])),n}function z(e,t){t.forEach(t=>{let n=t.object;n.position&&(n.position=q(e.position)),n.rotation&&(n.rotation=B(e.rotation)),n.scaling&&(n.scaling=q(e.scale))})}class L extends t.System{constructor(){super(...arguments),this.scenes=new Map,this._lastTime=0,this._isRendering=!1}get activeScene(){return this._activeScene}get currentCamera(){return this._currentCamera}init(){this._render=this._render.bind(this)}execute(){this.queries.camera.added.forEach(t=>{let n=t.getComponent(i),r=this.getScene(n.sceneName);n.object=new e.VRExperienceHelper(r,n.options),r===this._activeScene&&(this._currentCamera=n,this._isRendering=!0)}),this.queries.camera.removed.forEach(e=>{let t=e.getComponent(i);E(t),this.getScene(t.sceneName)===this._activeScene&&(this._isRendering=!1)})}start(t,n,i,r){return this.engine=new e.Engine(t,n,i,r),this._lastTime=performance.now(),this.engine.runRenderLoop(this._render),this}getScene(e){return e?this.scenes.get(e):this._activeScene}addScene(t,n){let i=new e.Scene(this.engine,n);return this.scenes.set(t,i),1===this.engine.scenes.length&&(this._activeScene=i),this}_render(){let e=performance.now();_(this).execute(e-this._lastTime,e),this._isRendering&&_(this).enabled&&this._activeScene.render(),this._lastTime=e}}L.queries={camera:{components:[i],listen:{added:!0,removed:!0}}};class D extends t.System{init(){window.addEventListener("load",()=>{this.queries.object.results.forEach(e=>{e.getComponent(n).updateObjects&&z(e.getComponent(n),k(e))})})}execute(){this.queries.object.changed.forEach(e=>{e.getComponent(n).updateObjects&&z(e.getComponent(n),k(e))})}}D.queries={object:{components:[n],listen:{changed:[n]}}};class H extends t.System{execute(){this.queries.mesh.added.forEach(t=>{let n=t.getComponent(f);n.object=e.MeshBuilder[`Create${n.type}`].call(null,n.type,n.options,M(this,n.sceneName))}),this.queries.mesh.removed.forEach(e=>{E(e.getComponent(f))})}}H.queries={mesh:{components:[f],listen:{added:!0,removed:!0}}},function(e){e.specular="specular"}(d||(d={})),function(e){e.direction="direction"}(h||(h={}));class N extends t.System{execute(){this.queries.light.added.forEach(t=>{let n=t.getComponent(y),i=q(n.direction),r=M(this,n.sceneName);switch(n.type){case s.Point:n.object=new e.PointLight(n.type,e.Vector3.Zero(),r);break;case s.Directional:n.object=new e.DirectionalLight(n.type,i,r);break;case s.Spot:n.object=new e.SpotLight(n.type,e.Vector3.Zero(),i,j(n.angle),n.exponent,r);break;default:n.object=new e.HemisphericLight(s.Hemispheric,i,r)}this._updateLight(n)}),this.queries.light.changed.forEach(e=>{this._updateLight(e.getComponent(y))}),this.queries.light.removed.forEach(e=>{E(e.getComponent(y))})}_updateLight(e){let t=e.object;Object.keys(e).forEach(n=>{d[n]?t[n]=R(e[n]):h[n]?t[n]=q(e[n]):t[n]=e[n]})}}N.queries={light:{components:[y],listen:{added:!0,removed:!0,changed:!0}}},function(e){e.diffuse="diffuse",e.specular="specular",e.emissive="emissive",e.ambient="ambient"}(u||(u={}));class A extends t.System{execute(){this.queries.meshMaterial.added.forEach(t=>{let n=t.getComponent(b);n.object=new e.StandardMaterial(n.diffuse,M(this,n.sceneName)),this._updateMaterial(n),t.getComponent(f).object.material=n.object}),this.queries.meshMaterial.changed.forEach(e=>{this._updateMaterial(e.getComponent(b))}),this.queries.meshMaterial.removed.forEach(e=>{E(e.getComponent(b)),e.getComponent(f).object.material=null})}_updateMaterial(e){let t=e.object;Object.keys(e).forEach(n=>{u[n]?t[`${n}Color`]=R(e[n]):"texture"===n?e.texture&&V(e,e.texture,this):t[n]=e[n]})}}A.queries={meshMaterial:{components:[f,b],listen:{added:!0,removed:!0,changed:[b]}}},function(e){e.textureMask="textureMask"}(l||(l={})),function(e){e.emitter="emitter",e.direction1="direction1",e.direction2="direction2"}(m||(m={}));class $ extends t.System{execute(){this.queries.particle.added.forEach(t=>{let n=t.getComponent(C);n.object=new e.ParticleSystem(n.type,n.capacity,M(this,n.sceneName));let i=n.object;switch(n.type){case o.Point:i.createPointEmitter(q(n.direction1),q(n.direction2));break;case o.Box:i.createBoxEmitter(q(n.direction1),q(n.direction2),q(n.minEmitBox),q(n.maxEmitBox));break;case o.Sphere:i.createSphereEmitter(n.radius,n.radiusRange);break;case o.DirectedSphere:i.createDirectedSphereEmitter(n.radius,q(n.direction1),q(n.direction2));break;case o.Hemisphere:i.createHemisphericEmitter(n.radius,n.radiusRange);break;case o.Cylinder:i.createCylinderEmitter(n.radius,n.height,n.radiusRange,Math.random());break;case o.DirectedCylinder:i.createDirectedCylinderEmitter(n.radius,n.height,n.radiusRange,q(n.direction1),q(n.direction2));break;case o.Cone:i.createConeEmitter(n.radius,n.angle)}this._updateParticle(n),i.start()}),this.queries.particle.changed.forEach(e=>{this._updateParticle(e.getComponent(C))}),this.queries.particle.removed.forEach(e=>{let t=e.getComponent(C);t.object.stop(),E(t)})}_updateParticle(e){let t=e.object;Object.keys(e).forEach(n=>{m[n]?t[n]=q(e[n]):l[n]?t[n]=O(e[n]):"texture"===n?e.texture&&V(e,e.texture,this):t[n]=e[n]})}}$.queries={particle:{components:[C],listen:{added:!0,changed:!0,removed:!0}}};class F extends t.System{execute(){this.queries.asset.added.forEach(t=>{let i=t.getComponent(x);this._assetManager||(this._assetManager=new e.AssetsManager(M(this,i.sceneName))),this._assetManager.useDefaultLoadingScreen=!1,i.type,this._loadBabylon(t.getComponent(n),i),this._assetManager.load()}),this.queries.asset.removed.forEach(e=>{E(e.getComponent(x))})}_loadBabylon(e,t){let n=t.url.lastIndexOf("/")+1;this._assetManager.addMeshTask(a.Babylon,"",t.url.substring(0,n),t.url.substring(n,t.url.length)).onSuccess=n=>{t.object=n.loadedMeshes[0],z(e,[t])}}}F.queries={asset:{components:[n,x],listen:{added:!0,removed:!0}}},function(e){e.onMainButton="onMainButton",e.onPad="onPad",e.onSecondaryButton="onSecondaryButton",e.onTrigger="onTrigger"}(p||(p={})),function(e){e.onPadValues="onPadValues"}(g||(g={}));class I extends t.System{constructor(){super(...arguments),this._isControllerConntected=!1}execute(){this.queries.input.added.forEach(e=>{let t=e.getMutableComponent(n);t&&e.getComponent(S).type.startsWith("Vr")&&(t.updateObjects=!1)}),this.queries.input.results.forEach(e=>{let t=T(this).object.webVRCamera.controllers,i=e.getMutableComponent(S);t.length>0&&(this._isControllerConntected?this._updateObjectsTransform(e,i.object,e.getMutableComponent(n)):this._initVRController(i,t))})}_initVRController(e,t){e.type===c.VrLeft?e.object=this._getVRController(t,"left"):e.object=this._getVRController(t,"right"),this._bindControllerBehaviours(e),this._isControllerConntected=!0}_getVRController(e,t){return e.find(e=>e.hand===t)}_bindControllerBehaviours(e){Object.keys(e).filter(e=>e in p).forEach(t=>{e[t]&&e.object[`${t}StateChangedObservable`].add(n=>{e[t].call(e,n.pressed,n.touched,n.value)})}),Object.keys(e).filter(e=>e in g).forEach(t=>{e[t]&&e.object[`${t}ChangedObservable`].add(n=>{e[t].call(e,n.x,n.y)})})}_updateObjectsTransform(e,t,n){n&&k(e).filter(e=>!(e instanceof S)).forEach(e=>{let i=t.devicePosition,r=t.deviceRotationQuaternion.toEulerAngles(),s=e.object;s.position&&(s.position=i),s.rotation&&(s.rotation=r),s.scaling&&(s.scaling=q(n.scale)),n.position=w(i),n.rotation=P(r)})}}I.queries={input:{components:[S],listen:{added:!0}}};var G=Object.freeze({__proto__:null,GameSystem:L,TransformSystem:D,MeshSystem:H,LightSystem:N,MaterialSystem:A,ParticleSystem:$,AssetSystem:F,InputSystem:I,Transform:n,Camera:i,get MeshTypes(){return r},Mesh:f,get LightTypes(){return s},Light:y,Material:b,get ParticleTypes(){return o},Particle:C,get AssetTypes(){return a},Asset:x,get InputTypes(){return c},Input:S,degreeToRadians:j,radiansToDegree:function(t){return e.Angle.FromRadians(t).degrees()},getWorld:_,disposeObject:E,getScene:M,getCamera:T,xyzToVector3:q,xyzToVector3Radians:B,vector3ToXyz:w,vector3ToXyzDegree:P,hexToColor3:R,hexToColor4:O,updateTexture:V,getEntityObjectComponents:k,updateObjectsTransform:z});window.EB=G}(BABYLON,ECSY);
