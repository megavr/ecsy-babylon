!function(e,t){"use strict";function n(e){return e.world}function i(e){return n(e).getSystems().find(e=>e.engine)}function r(e,t){return i(e).getScene(t)}function o(e,t){return i(e).getAssetManager(t)}function s(e){return i(e).activeCameraEntity}function a(t){return e.Angle.FromDegrees(t).radians()}function c(t){return new e.Vector3(t.x,t.y,t.z)}function d(t){return new e.Vector3(a(t.x),a(t.y),a(t.z))}function h(e){return{x:e.x,y:e.y,z:e.z}}function l(e){return{x:e.x,y:e.y,z:e.z}}function u(t){return e.Color3.FromHexString(t)}function m(t){return e.Color4.FromHexString(t)}function p(e,t,n){return e&&t&&n?{x:e,y:t,z:n}:{x:0,y:0,z:0}}class g{constructor(){this.position=p(),this.rotation=p(),this.scale=p(1,1,1),this.updateObjects=!0}}class f{constructor(){this.options={}}}var y,b,C,S,x,_,E;!function(e){e.Box="Box",e.Plane="Plane",e.Sphere="Sphere",e.Ground="Ground"}(y||(y={}));class v{constructor(){this.type=y.Box,this.options={}}}!function(e){e.Point="Point",e.Directional="Directional",e.Spot="Spot",e.Hemispheric="Hemispheric"}(b||(b={}));class j{constructor(){this.type=b.Hemispheric,this.direction=p()}}function M(e,t){e.object[t]=e[t]}function w(e,t){e.object[t]=c(e[t])}function q(e){let t=e.getComponents();for(let n in t){let i=t[n];i.object&&e.hasComponent(g)&&B(e.getMutableComponent(g),i)}}function B(e,t){let n=t.object;n.position&&(n.position=c(e.position)),n.rotation&&(n.rotation=d(e.rotation)),n.scaling&&(n.scaling=c(e.scale))}function k(e){e.object&&e.object.dispose()}function T(e,t,n){for(let i in t){let r=t[i];n.addTextureTask(i,r.url).onSuccess=t=>{let n=t.texture;for(let e in r)"url"!==e&&(n[e]=r[e]);let o=`${i}Texture`,s=e.object;s[o]&&k(s[o]),s[o]=n}}n.load(),n.reset()}class P{constructor(){var e;this.color=e?{diffuse:e}:{diffuse:"#ffffff"}}}!function(e){e.Point="Point",e.Box="Box",e.Sphere="Sphere",e.DirectedSphere="DirectedSphere",e.Hemisphere="Hemisphere",e.Cylinder="Cylinder",e.DirectedCylinder="DirectedCylinder",e.Cone="Cone"}(C||(C={}));class R{constructor(){this.type=C.Point,this.capacity=100,this.emitter=p(),this.direction1=p(),this.direction2=p(10,10,10),this.minEmitBox=p(),this.maxEmitBox=p()}}!function(e){e.Babylon="Babylon"}(S||(S={}));class V{constructor(){this.type=S.Babylon}}!function(e){e.Keyboard="Keyboard",e.VrRight="VrRight",e.VrLeft="VrLeft"}(x||(x={}));class L{constructor(){this.type=x.VrRight}}class D extends t.System{constructor(){super(...arguments),this._scenes=new Map,this._assetManagers=new Map,this._isRendering=!1}get activeSceneName(){return this._activeSceneName}get activeCameraEntity(){return this._activeCameraEntity}init(){this._render=this._render.bind(this)}execute(){this.queries.camera.added.forEach(t=>{let n=t.getComponent(f),i=this.getScene(n.sceneName);n.object=new e.VRExperienceHelper(i,n.options),i===this._activeScene&&(this._activeCameraEntity=t,this._isRendering=!0),q(t)}),this.queries.camera.removed.forEach(e=>{let t=e.getComponent(f);k(t),this.getScene(t.sceneName)===this._activeScene&&(this._isRendering=!1)})}start(t,n,i,r){return this.engine=new e.Engine(t,n,i,r),this.engine.runRenderLoop(this._render),this}addScene(t,n){let i=new e.Scene(this.engine,n),r=new e.AssetsManager(i);return r.useDefaultLoadingScreen=!1,this._scenes.set(t,i),this._assetManagers.set(t,r),1===this.engine.scenes.length&&(this._activeScene=i,this._activeSceneName=t),this}removeScene(e){return e!==this.activeSceneName&&this.getScene(e).dispose(),this}switchScene(e,t){return this.getScene(e)&&(this._activeScene=this.getScene(e),this._activeSceneName=e,this._activeCameraEntity=t),this}getScene(e){return e?this._scenes.get(e):this._activeScene}getAssetManager(e){let t=this.activeSceneName;return e&&(t=e),this._assetManagers.get(t)}_render(){n(this).execute(this.engine.getDeltaTime(),performance.now()),this._isRendering&&n(this).enabled&&this._activeScene.render()}}D.queries={camera:{components:[f],listen:{added:!0,removed:!0}}};class N extends t.System{execute(){this.queries.transforms.changed.forEach(e=>{e.getComponent(g).updateObjects&&q(e)})}}N.queries={transforms:{components:[g],listen:{added:!0,changed:[g]}}};class z extends t.System{execute(){this.queries.mesh.added.forEach(t=>{let n=t.getComponent(v);n.object=e.MeshBuilder[`Create${n.type}`].call(this,n.type,n.options,r(this,n.sceneName)),q(t)}),this.queries.mesh.changed.forEach(e=>{let t=e.getMutableComponent(v);for(let e in t)M(t,e)}),this.queries.mesh.removed.forEach(e=>{k(e.getComponent(v))})}}z.queries={mesh:{components:[v],listen:{added:!0,removed:!0,changed:[v]}}};class H extends t.System{execute(){this.queries.light.added.forEach(t=>{let n=t.getComponent(j),i=c(n.direction),o=r(this,n.sceneName);switch(n.type){case b.Point:n.object=new e.PointLight(n.type,e.Vector3.Zero(),o);break;case b.Directional:n.object=new e.DirectionalLight(n.type,i,o);break;case b.Spot:n.object=new e.SpotLight(n.type,e.Vector3.Zero(),i,a(n.angle),n.exponent,o);break;default:n.object=new e.HemisphericLight(b.Hemispheric,i,o)}this._updateLight(n),q(t)}),this.queries.light.changed.forEach(e=>{this._updateLight(e.getComponent(j))}),this.queries.light.removed.forEach(e=>{k(e.getComponent(j))})}_updateLight(e){for(let t in e)switch(t){case"direction":w(e,t);break;case"color":this._updateColor(e,e.color);break;default:M(e,t)}}_updateColor(e,t){for(let n in t)e.object[n]=u(t[n])}}H.queries={light:{components:[j],listen:{added:!0,removed:!0,changed:[j]}}};class A extends t.System{execute(){this.queries.meshMaterial.added.forEach(t=>{let n=t.getComponent(P);n.object=new e.StandardMaterial(n.color.diffuse,r(this,n.sceneName)),this._updateMaterial(n),t.getComponent(v).object.material=n.object}),this.queries.meshMaterial.changed.forEach(e=>{this._updateMaterial(e.getComponent(P))}),this.queries.meshMaterial.removed.forEach(e=>{k(e.getComponent(P)),e.getComponent(v).object.material=null})}_updateMaterial(e){for(let t in e)switch(t){case"color":this._updateColor(e,e.color);break;case"texture":T(e,e.texture,o(this,e.sceneName));break;default:M(e,t)}}_updateColor(e,t){for(let n in t)e.object[`${n}Color`]=u(t[n])}}A.queries={meshMaterial:{components:[v,P],listen:{added:!0,removed:!0,changed:[P]}}};class O extends t.System{execute(){this.queries.particle.added.forEach(t=>{let n=t.getComponent(R);n.object=new e.ParticleSystem(n.type,n.capacity,r(this,n.sceneName));let i=n.object;switch(n.type){case C.Point:i.createPointEmitter(c(n.direction1),c(n.direction2));break;case C.Box:i.createBoxEmitter(c(n.direction1),c(n.direction2),c(n.minEmitBox),c(n.maxEmitBox));break;case C.Sphere:i.createSphereEmitter(n.radius,n.radiusRange);break;case C.DirectedSphere:i.createDirectedSphereEmitter(n.radius,c(n.direction1),c(n.direction2));break;case C.Hemisphere:i.createHemisphericEmitter(n.radius,n.radiusRange);break;case C.Cylinder:i.createCylinderEmitter(n.radius,n.height,n.radiusRange,Math.random());break;case C.DirectedCylinder:i.createDirectedCylinderEmitter(n.radius,n.height,n.radiusRange,c(n.direction1),c(n.direction2));break;case C.Cone:i.createConeEmitter(n.radius,n.angle)}this._updateParticle(n),q(t),i.start()}),this.queries.particle.changed.forEach(e=>{this._updateParticle(e.getComponent(R))}),this.queries.particle.removed.forEach(e=>{let t=e.getComponent(R);t.object.stop(),k(t)})}_updateParticle(e){for(let t in e)switch(t){case"emitter":case"direction1":case"direction2":case"minEmitBox":case"maxEmitBox":w(e,t);break;case"texture":T(e,e.texture,o(this,e.sceneName));break;case"color":this._updateColor(e,e.color);break;default:M(e,t)}}_updateColor(e,t){for(let n in t)e.object[n]=m(t[n])}}O.queries={particle:{components:[R],listen:{added:!0,removed:!0,changed:[R]}}};class K extends t.System{execute(){this.queries.asset.added.forEach(e=>{let t=e.getComponent(V),n=o(this,t.sceneName);switch(t.type){default:{let i=t.url.lastIndexOf("/")+1;n.addMeshTask(S.Babylon,"",t.url.substring(0,i),t.url.substring(i,t.url.length)).onSuccess=n=>{t.object=n.loadedMeshes[0],q(e)};break}}n.load(),n.reset()}),this.queries.asset.removed.forEach(e=>{k(e.getComponent(V))})}}K.queries={asset:{components:[V],listen:{added:!0,removed:!0}}},function(e){e.onMainButton="onMainButton",e.onPad="onPad",e.onSecondaryButton="onSecondaryButton",e.onTrigger="onTrigger"}(_||(_={})),function(e){e.onPadValues="onPadValues"}(E||(E={}));class $ extends t.System{constructor(){super(...arguments),this._isControllerConntected=!1}execute(){this.queries.input.added.forEach(e=>{let t=e.getComponent(L);switch(t.type){case x.Keyboard:t.onKey&&(window.addEventListener("keydown",e=>t.onKey.call(t,e.key,!0,!1)),window.addEventListener("keyup",e=>t.onKey.call(t,e.key,!1,!0)));break;default:e.hasComponent(g)&&(e.getMutableComponent(g).updateObjects=!1)}}),this.queries.input.results.forEach(e=>{let t=s(this).getComponent(f).object.webVRCamera.controllers,n=e.getMutableComponent(L);t.length>0&&(this._isControllerConntected?this._updateObjectsTransform(e,n.object,e.getMutableComponent(g)):this._initVRController(n,t))})}_initVRController(e,t){e.type===x.VrLeft?e.object=this._getVRController(t,"left"):e.object=this._getVRController(t,"right"),this._bindControllerBehaviours(e),this._isControllerConntected=!0}_getVRController(e,t){return e.find(e=>e.hand===t)}_bindControllerBehaviours(e){for(let t in e)e[t]&&(t in _&&e.object[`${t}StateChangedObservable`].add(n=>{e[t].call(e,n.pressed,n.touched,n.value)}),t in E&&e.object[`${t}ChangedObservable`].add(n=>{e[t].call(e,n.x,n.y)}))}_updateObjectsTransform(e,t,n){n&&function(e){let t=e.getComponents(),n=[];for(let e in t){let i=t[e];i.object&&n.push(i)}return n}(e).filter(e=>!(e instanceof L)).forEach(e=>{let i=t.devicePosition,r=t.deviceRotationQuaternion.toEulerAngles(),o=e.object;o.position&&(o.position=i),o.rotation&&(o.rotation=r),o.scaling&&(o.scaling=c(n.scale)),n.position=h(i),n.rotation=l(r)})}}$.queries={input:{components:[L],listen:{added:!0}}};var F=Object.freeze({__proto__:null,GameSystem:D,TransformSystem:N,MeshSystem:z,LightSystem:H,MaterialSystem:A,ParticleSystem:O,AssetSystem:K,InputSystem:$,Transform:g,Camera:f,get MeshTypes(){return y},Mesh:v,get LightTypes(){return b},Light:j,Material:P,get ParticleTypes(){return C},Particle:R,get AssetTypes(){return S},Asset:V,get InputTypes(){return x},Input:L,degreeToRadians:a,radiansToDegree:function(t){return e.Angle.FromRadians(t).degrees()},xyzToVector3:c,xyzToVector3Radians:d,vector3ToXyz:h,vector3ToXyzDegree:l,hexToColor3:u,hexToColor4:m,xyz:p,getAssetManager:o,getCamera:s,getScene:r});window.EB=F}(BABYLON,ECSY);
